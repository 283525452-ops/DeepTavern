您说得非常对！非常感谢您的指正。
# 🏰 DeepTavern Core (v0.5)

![Version](https://img.shields.io/badge/version-v0.5.0-blue)
![Python](https://img.shields.io/badge/python-3.10%2B-green)
![Architecture](https://img.shields.io/badge/Architecture-Multi--Agent-purple)
![License](https://img.shields.io/badge/license-MIT-orange)
![GraphRAG](https://img.shields.io/badge/Tech-GraphRAG-red)

**DeepTavern** 是一个基于 **多智能体协作 (Multi-Agent)** 与 **动态知识图谱 (GraphRAG)** 构建的深度交互式 RPG 引擎。

它旨在解决大模型角色扮演（RP）中的三大痛点：**逻辑崩坏**、**记忆遗忘**和**世界空洞**。通过将“思考”与“写作”分离，并引入真实的游戏状态机，DeepTavern 让 AI 不再只是陪聊的机器人，而是成为了一个能够运行复杂世界观的**地下城主 (DM)**。

> **🛑 新手必读：核心概念**
> *   **DeepTavern (后端)** = **DVD 播放机**。它负责处理光盘、解码画面、处理逻辑。
> *   **SillyTavern (前端)** = **电视机**。它只负责把画面显示出来给你看。
> *   **结论**：你需要在电脑上同时运行这两个程序。DeepTavern 处理所有脑力活，SillyTavern 只是一个显示器。**请不要在显示器（酒馆）里设置复杂的剧情逻辑，那没用。**

---

## 📚 目录

1.  [深度解析：九大智能体 (The 9-Agent Architecture)](#-深度解析九大智能体-the-9-agent-architecture)
2.  [核心技术：超越 RAG 的记忆引擎](#-核心技术超越-rag-的记忆引擎)
3.  [安装与部署指南](#-安装与部署指南)
4.  [模型配置策略 (丰俭由人)](#-模型配置策略-丰俭由人)
5.  [前端连接：SillyTavern 设置](#-前端连接sillytavern-设置)
6.  [游戏指南：存档与操作](#-游戏指南存档与操作)
7.  [进阶工具：预设清洗与规则库](#-进阶工具预设清洗与规则库)
8.  [常见问题 (FAQ)](#-常见问题-faq)

---

## 🧠 深度解析：九大智能体 (The 9-Agent Architecture)

DeepTavern 的每一次对话响应，并非由单一模型生成，而是一条精密的**工业流水线**。我们将大脑拆解为 9 个独立的功能模块，各司其职。

### 第一梯队：前台响应组 (同步运行)
*这组模型决定了你“看到回复”的速度。它们必须串行工作，逻辑环环相扣。*

| Agent (代号) | 角色名 | 核心职责详解 | 运行频率 | 建议模型 |
| :--- | :--- | :--- | :--- | :--- |
| **Reflex** | **反射层** | **【看门人与翻译官】**<br>它是系统的第一道防线。它首先检查你的输入是否安全。然后，它通过意图识别，判断你是想推动剧情，还是想查询设定。最重要的是，它会将你的口语（如“那把剑在哪？”）翻译成数据库能听懂的**精准搜索词**（如`Query: 霜之哀伤 位置`），从而激活 RAG 系统。 | **每轮** | **速度型**<br>Qwen-2.5-7B, Haiku, GPT-3.5 |
| **Director** | **导演** | **【逻辑大脑 - CPU】**<br>这是 DeepTavern 最核心的创新。**它绝不写小说正文**。它像一个冷酷的程序员，阅读当前的状态（HP剩余、好感度等级）、检索到的记忆和规则。它进行逻辑推演：技能是否命中？NPC 是否在撒谎？剧情是否反转？最终输出一份 `Director's Note`（剧本大纲）。 | **每轮** | **智商型**<br>DeepSeek-V3, GPT-4o, Claude-3.5-Sonnet |
| **Narrator** | **叙事者** | **【文学大脑 - GPU】**<br>它是唯一的“写手”。它读取导演那份枯燥的剧本大纲，将其渲染为沉浸感极强的小说片段。它负责环境描写（氛围、光影）、感官细节（痛觉、触觉）和人物对白。它不需要很强的逻辑，但需要极好的文笔和语感。 | **每轮** | **文笔型**<br>Claude-3.5-Sonnet, Gemini-1.5-Pro |

### 第二梯队：后台处理组 (异步运行)
*这组模型在你看到回复的同时，在后台默默工作。它们不占用你的等待时间，但决定了 AI 的“记性”和“情商”。*

| Agent (代号) | 角色名 | 核心职责详解 | 运行频率 | 建议模型 |
| :--- | :--- | :--- | :--- | :--- |
| **Status** | **状态引擎** | **【世界模拟器】**<br>它阅读刚才发生的剧情，将自然语言转化为 JSON 数据更新。例如：检测到“你喝下红药水”，它会在后台将你的 `HP +50`，并从 `Inventory` 中删除药水。同时负责推进世界时间（从早晨到中午）。 | **每轮** (后台) | **代码/JSON强**<br>DeepSeek-Coder, Qwen-Coder |
| **Sociologist**| **社会学家** | **【读心师】**<br>它深度分析对话中的潜台词、微表情和情感流动。它不是简单地加减好感度数值，而是更新图谱中的**关系描述**（如：从“陌生”变为“因误会而产生的怀疑”）。它让 NPC 的人际关系变得立体。 | **每轮** (后台) | **心理分析强**<br>擅长 Roleplay 的模型 |
| **Graph** | **图谱提取** | **【制图师】**<br>它从文本中提取实体三元组 `(Source) --Relation--> (Target)`。例如从“我来自凛冬城”提取 `(Player) --来自--> (凛冬城)`。它不断编织一张巨大的关系网，让 AI 越聊越懂这个世界。 | **每轮** (后台) | **信息提取强**<br>Qwen-14B, GPT-4o-mini |

### 第三梯队：记忆维护组 (定期维护)
*这组模型负责对抗遗忘，将短期记忆转化为长期记忆。*

| Agent (代号) | 角色名 | 核心职责详解 | 运行频率 | 建议模型 |
| :--- | :--- | :--- | :--- | :--- |
| **Left Brain**| **左脑** | **【速记员】**<br>当积累了 5 轮对话后，左脑会将这些对话压缩成一段简练的摘要草稿。 | **每 5 轮** | 7B-14B 级别 |
| **Critic** | **右脑** | **【编辑】**<br>右脑紧随左脑启动。它审核左脑的草稿，补充被遗漏的关键情感细节或伏笔，生成最终的 **“微观记忆 (Micro Memory)”** 并存入向量库。 | **每 5 轮** | 逻辑较强模型 |
| **Historian** | **史官** | **【作家】**<br>当微观记忆积累过多（通常每 50 轮），史官会将它们改写为一段史诗般的 **“章节 (Saga)”**，永久归档到数据库，并清空上下文窗口。这是实现无限长剧情的关键。 | **每 50+ 轮** | 文笔极好模型 |

---

## 🔬 核心技术：超越 RAG 的记忆引擎

DeepTavern 不仅仅是把文本塞进数据库，它构建了一个立体的认知空间。

### 1. 动态知识图谱 (Dynamic GraphRAG)
传统的 RAG 只能检索相似的句子。DeepTavern 引入了 **NetworkX 图数据库**。
*   **自动构建**：当你提到“爱丽丝是鲍勃的姐姐”时，后台会自动建立 `(爱丽丝) --姐姐--> (鲍勃)` 的连接。
*   **多跳推理**：当你问“鲍勃的亲戚是谁？”时，即使文本里没直接写，系统也能通过图谱找到爱丽丝。
*   **向量增强**：图谱中的节点都经过了 Embedding 向量化，支持模糊语义搜索（比如搜“那个拿剑的女孩”能找到“爱丽丝”）。

### 2. 递归摘要记忆 (Recursive Summarization)
我们抛弃了简单的“滑动窗口”记忆法，采用了仿生学的记忆压缩机制：
*   **Level 1 (Context)**: 最近 20 轮对话，保留完整原文，用于保持对话流畅。
*   **Level 2 (Micro)**: 每 5 轮生成一次摘要，存入向量库。AI 可以随时检索很久以前的细节。
*   **Level 3 (Macro)**: 每 10 条微观记忆合并为宏观记忆。
*   **Level 4 (Saga)**: 章节小说，用于长线剧情回顾。
*   **效果**：哪怕你玩了 1000 轮，AI 依然能通过检索 Level 3/4 的记忆，回忆起第 1 轮发生的关键事件，同时保持极低的 Token 消耗。

### 3. 主动知识获取 (Harvester)
DeepTavern 拥有“好奇心”。
*   当 Left Brain 在总结时发现未知的专有名词（例如“黑神话剧情”），它会触发 **Harvester** 模块。
*   系统会调用爬虫（DuckDuckGo/Jina）去互联网搜索相关资料。
*   资料经过清洗后，作为 **Lore (世界设定)** 存入数据库。下次再聊到这个话题，AI 就懂了。

---

## 🛠 安装与部署指南

### 环境要求
*   **系统**: Windows 10/11 (推荐), Linux, macOS
*   **Python**: 3.10 或更高版本
*   **显卡**:
    *   **在线模式 (推荐)**: 任意显卡（甚至集显），只需流畅网络。
    *   **本地模式**: 推荐 NVIDIA 显卡，至少 8GB 显存（运行量化版 7B 模型），推荐 24GB+ 以获得最佳体验。

### 步骤 1：获取代码
```bash
git clone https://github.com/your-repo/DeepTavern.git
cd DeepTavern
```

### 步骤 2：一键初始化 (Windows)
双击根目录下的 **`start_env.bat`**。
*   脚本会自动创建 Python 虚拟环境。
*   自动安装所有依赖 (`pip install -r requirements.txt`)。
*   *Linux/Mac 用户请手动创建 venv 并安装依赖。*

### 步骤 3：启动配置工具
双击 **`start_editor.bat`** (或运行 `python config_editor.py`)。
这将打开 DeepTavern 控制中心，你可以在这里配置 API Key 和模型分配。

---

## 🎛 模型配置策略 (丰俭由人)

由于使用了 9 个 Agent，如何分配模型直接决定了体验和成本。以下是三种推荐方案：

### 💎 方案 A：全能土豪版 (体验天花板)
*追求极致的逻辑和文笔，不差钱。*
*   **Director / Narrator / Historian** -> **GPT-4o** 或 **Claude-3.5-Sonnet**
*   **其他所有 Agent** -> **GPT-4o-mini**
*   **特点**：逻辑无敌，文笔细腻，几乎没有幻觉，但 API 成本较高。

### ⚖️ 方案 B：高性价比版 (强烈推荐)
*利用 DeepSeek 和 SiliconFlow 的低价/免费 API，获得接近顶级的体验。*
*   **Director (导演)** -> **DeepSeek-V3** (逻辑强，极其便宜)。
*   **Narrator (叙事者)** -> **Claude-3.5-Sonnet** (文笔最好) 或 **DeepSeek-V3**。
*   **Status / Sociologist** -> **DeepSeek-V3** (分析能力强)。
*   **Reflex / Graph / Brains** -> **Qwen-2.5-7B** (SiliconFlow 免费版) 或 **GPT-4o-mini**。
*   **特点**：成本极低（甚至接近免费），效果达到方案 A 的 90%。

### 🔒 方案 C：本地隐私版 (硬核玩家)
*需要强力显卡，数据完全不出本地。*
*   **Director / Narrator** -> 本地加载 **Llama-3-70B-GGUF** 或 **Qwen-2.5-72B-GGUF** (需 24G+ 显存)。
*   **其他 Agent** -> 本地加载 **Mistral-7B** 或 **Qwen-7B** (需 8G+ 显存)。
*   **特点**：完全离线，隐私安全，但对硬件要求极高，且速度可能较慢。

---

## 🖥️ 前端连接：SillyTavern 设置

1.  打开 **SillyTavern (酒馆)**。
2.  点击顶部的插头图标 (**API Connections**)。
3.  **API Type (类型)**: 选择 `Chat Completion` (旧版本可能叫 OpenAI)。
4.  **API Source (来源)**: 选择 `Custom` (自定义) 或 `OpenAI Compatible`。
5.  **API Endpoint (地址)**: 填写 `http://127.0.0.1:8000/v1`
    *   *注意：末尾的 `/v1` 是必须的！*
6.  **API Key**: 随便填一个字符串 (例如 `123456`)。
    *   *DeepTavern 不验证这个 Key，它使用的是你后台配置好的真实 Key。*
7.  点击 **Connect**。绿灯亮起即成功。

### ⚠️ 关键设置 (必读！)
为了防止酒馆自带的逻辑干扰 DeepTavern，请务必：
*   **新建角色**：创建一个名字叫 "AI" 的角色，**描述、首条消息、世界书全部留空**。
*   **关闭功能**：在酒馆设置里，关闭 "Auto-Summary" (自动总结)、"Vector Storage" (向量库)、"World Info" (世界书)。DeepTavern 后台已经有更高级的版本了，重复开启会浪费 Token 并造成逻辑冲突。
*   **预设**：使用默认的 `Default` 预设即可。

---

## 🎮 游戏指南：存档与操作

**DeepTavern v0.5 采用独立的后端存档系统。**
酒馆前端的“新建聊天”按钮**无法**重置 DeepTavern 的后台状态（如背包、好感度、图谱）。

### 正确的游戏流程

#### 1. 启动
*   双击 **`run_backend.bat`** 启动后端服务（保持黑窗口开启）。
*   双击 **`start_editor.bat`** 启动监控台。

#### 2. 开始新游戏 (New Game)
1.  在 **监控台** -> **存档管理** 页面。
2.  输入玩家名字，点击 **“新建存档”**。
3.  *（此时后台会生成一个新的 UUID，重置所有状态）*
4.  在 **酒馆** 里发送第一句话（如：“我醒来了”）。

#### 3. 读取进度 (Load Game)
1.  在 **监控台** -> **存档管理** 页面。
2.  在列表中选择之前的存档，点击 **“加载选中存档”**。
3.  DeepTavern 会从数据库恢复当时的状态、记忆和图谱。
4.  在 **酒馆** 里继续对话。

#### 4. 监控与调试
在游戏过程中，你可以随时查看监控台：
*   **系统终端**：查看 9 个 Agent 的实时工作日志。
*   **导演思维链**：点击 **“导演思维链”** 标签，偷看 AI 导演的 `Director's Note`。你可以看到它是如何判定你的技能失败，或者如何安排 NPC 背叛你的。这非常有趣！

---

## 🛠️ 进阶工具：预设清洗与规则库

DeepTavern v0.5 引入了 **“预设清洗工具”** (Ingest Tool)，这是一个专门用于将 **SillyTavern 预设 (Presets)** 转化为向量规则的工具。

### 它的作用是什么？
它用于导入 **“规则 (Rules)”**，而不是“设定 (Lore)”。
*   ✅ **适合导入**：战斗描写指南、Markdown 格式要求、系统指令、特殊场景的描写规范。
*   ❌ **不适合导入**：世界历史、角色背景故事、城市设定（这些属于 Lore）。

### 如何使用？
1.  在控制中心打开 **“预设清洗工具”** 标签。
2.  选择一个 SillyTavern 的 `.json` 预设文件。
3.  工具会调用 LLM，将预设中的 Prompt 拆解、分类、打标签。
4.  这些规则会被存入 `rules_memory` 数据库。
5.  **实战效果**：当你在游戏中进入战斗时，系统会自动检索出“战斗描写指南”并注入给 Narrator；当你日常对话时，这些规则不会占用 Token。

---

## ❓ 常见问题 (FAQ)

**Q: 为什么回复速度比直接用 ChatGPT 慢？**
A: 因为这是链式思考。每一轮对话，Reflex -> Director -> Narrator 必须串行工作，而后台还有 Status、Sociologist、Graph 在并行处理。这是为了换取极致的逻辑深度和记忆能力。建议使用高速 API (如 Groq, SiliconFlow) 来加速小模型的处理。

**Q: 我能在酒馆里用 Lorebook (世界书) 吗？**
A: **在 v0.5 版本中，暂不支持直接导入世界书。**
目前的系统依赖 GraphRAG 和 Harvester（爬虫）来构建世界观。如果你直接导入世界书，Director 可能无法正确索引。我们将在 v0.6 版本中推出专门的 Lorebook 导入工具。目前建议直接在对话中通过自然语言建立设定，让 AI 自己去学。

**Q: 为什么 AI 总是说我背包里有东西，但我酒馆界面里没显示？**
A: 酒馆的界面无法读取 DeepTavern 的后台数据库。你可以直接问 AI：“检查我的背包”，Narrator 会读取后台数据并描写出来。下一版本我们将实现前端可视化。

**Q: 报错 `Connection Refused`？**
A: 请检查 `run_backend.bat` 是否正在运行，且黑窗口没有关闭。检查酒馆的 API 地址是否填对 (`http://127.0.0.1:8000/v1`)。

---

## 🔮 未来更新计划 (Roadmap)

我们深知当前版本的操作门槛较高。为了提供极致的“开箱即用”体验，下一阶段的开发重心将完全集中在 **“前端优先 (Frontend-First)”** 体验上。

**即将到来的功能：**
*   **✅ 全面兼容酒馆生态**：直接支持读取 SillyTavern 的 **角色卡 (PNG/JSON)**、**世界书 (World Info)** 和 **预设文件**。
*   **✅ 零后端操作**：你将不再需要打开 DeepTavern 的控制台。所有的存档切换、角色加载、世界书激活，都将**直接在酒馆前端操作**，DeepTavern 会自动在后台静默同步。
*   **✅ 动态热重载**：在酒馆里换一张卡，DeepTavern 的后台逻辑（导演/叙事者人格）会立刻自动切换，无需重启。

*(目前版本 v0.5 仍需使用下方的控制台进行手动管理，感谢您的理解与支持！)*


感谢您的使用与支持！如有 Bug，请在 GitHub 提交 Issue。
