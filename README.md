
# 🏰 DeepTavern Core (v0.5)

**DeepTavern** 是一个深度交互式 RPG 故事生成引擎。

与普通的聊天机器人不同，它不仅仅是“对话”，而是一个**拥有完整后台的游戏引擎**。它内置了 **导演(Director) - 叙事者(Narrator)** 双脑架构，拥有自己的生命值(HP)、物品栏、技能系统、人际关系网、知识图谱和记忆库。

> **⚠️ 给新手的核心提示：**
> DeepTavern 是一个**后端核心**。你需要使用 **SillyTavern (酒馆)** 或其他支持 OpenAI 格式的软件作为**前端显示界面**。
>
> **DeepTavern 接管了所有的逻辑**，因此目前阶段，你不需要（也不能）在酒馆里加载复杂的角色卡或世界书，DeepTavern 会自动处理逻辑。

---

## 🔮 未来更新计划 (Roadmap)

我们深知当前版本的操作门槛较高。为了提供极致的“开箱即用”体验，下一阶段的开发重心将完全集中在 **“前端优先 (Frontend-First)”** 体验上。

**即将到来的功能：**
*   **✅ 全面兼容酒馆生态**：直接支持读取 SillyTavern 的 **角色卡 (PNG/JSON)**、**世界书 (World Info)** 和 **预设文件**。
*   **✅ 零后端操作**：你将不再需要打开 DeepTavern 的控制台。所有的存档切换、角色加载、世界书激活，都将**直接在酒馆前端操作**，DeepTavern 会自动在后台静默同步。
*   **✅ 动态热重载**：在酒馆里换一张卡，DeepTavern 的后台逻辑（导演/叙事者人格）会立刻自动切换，无需重启。

*(目前版本 v0.5 仍需使用下方的控制台进行手动管理，感谢您的理解与支持！)*

---

## 🧠 核心模型与工作流详解

DeepTavern 并不是单体模型在工作，而是一个由 **9 个 AI Agent** 组成的精密流水线。了解它们的作用有助于你更好地配置系统。

| 角色 Key | 名称 | 职责与作用 | 调用频率 | 推荐模型类型 |
| :--- | :--- | :--- | :--- | :--- |
| **reflex** | **反射层** | **意图识别与安全网**。它会分析你的输入，判断你是想聊天、想搜索知识还是在尝试越狱。它还会将你的口语转化为精准的搜索关键词，用于 RAG 检索。 | **每轮** | 小参数、响应快 (如 Qwen-7B, Haiku) |
| **director** | **导演** | **逻辑大脑**。它不直接写小说，而是根据当前的状态（HP、物品、好感度）和规则，生成一份 `Director's Note`（剧本大纲）。它决定了剧情走向、判定成功/失败、以及 NPC 的心理活动。 | **每轮** | **高智商**、逻辑强 (如 DeepSeek-V3, GPT-4o) |
| **narrator** | **叙事者** | **文学大脑**。它读取导演的剧本大纲，将其扩写为沉浸感极强的小说片段。它负责描写环境氛围、感官细节（色声香味触）和人物对白。 | **每轮** | **文笔好**、长窗口 (如 Claude-3.5, Gemini-Pro) |
| **status** | **状态引擎** | **世界模拟器**。它在后台默默运行，分析刚刚发生的剧情，更新数据库中的 JSON 状态（如：扣除 HP、增加经验值、添加新物品、推进世界时间）。 | **每轮 (后台)** | 代码/JSON能力强 (如 DeepSeek-Coder, Qwen-Coder) |
| **left_brain** | **左脑** | **速记员**。负责将最近几轮的对话压缩成简练的“微观记忆”条目。 | 每 5 轮 | 中等模型 |
| **critic** | **右脑** | **质检员**。审核左脑生成的记忆，补充遗漏的情感细节，并将微观记忆合并为“宏观记忆”。 | 每 10 轮 | 逻辑强 |
| **historian** | **史官** | **史诗撰写者**。当宏观记忆积累到一定程度，它会将其改写为一段史诗般的章节，永久存入数据库。 | 每 50+ 轮 | 文笔极好 |
| **sociologist** | **社会学家** | **情感分析师**。分析对话中的潜台词和情感流动，更新人物关系图谱（不是简单的数值，而是复杂的关系描述）。 | 不定期 | 心理分析强 |
| **graph_extractor**| **图谱提取** | **知识构建者**。从对话中提取实体（人、地、物）及其关系，构建动态知识图谱。 | 后台运行 | 信息提取强 |

---

## 🚀 快速开始 (保姆级教程)

### 第一步：环境准备
确保你的电脑已安装 **Python 3.10 或更高版本**。

1.  下载本项目代码。
2.  双击运行根目录下的 **`start_env.bat`**。
3.  它会自动检测虚拟环境，如果没有，请在弹出的黑窗口里输入以下命令安装依赖：
    ```bash
    pip install -r requirements.txt
    ```

### 第二步：初始化配置
我们提供了一个图形化的配置工具，不需要改代码。

1.  双击运行 **`start_editor.bat`**，打开控制中心。
2.  **服务商配置**：添加你的 API Key (支持 OpenAI, SiliconFlow, DeepSeek, Ollama 等)。
3.  **角色模型分配**：根据上方的“核心模型详解”，为每个角色选择合适的模型。
    *   *省流版：Director 用最聪明的，Narrator 用文笔最好的，其他可以用便宜的或本地小模型。*
4.  点击底部的 **“保存所有配置”**。

### 第三步：启动后端服务
双击运行 **`run_backend.bat`**。
*   看到黑窗口显示 `Uvicorn running on http://0.0.0.0:8000` 字样时，说明后端启动成功！
*   **注意：在使用过程中，这个黑窗口不能关闭。**

---

## 🖥️ 如何连接前端 (SillyTavern / 酒馆)

DeepTavern 模拟了 OpenAI 的 API 格式，所以这就和连接 ChatGPT 一样简单。

1.  打开你的 **SillyTavern (酒馆)**。
2.  进入 **API 连接设置** (插头图标)。
3.  按照以下参数填写：
    *   **API Type (类型)**: `Chat Completion` (或 OpenAI)
    *   **API Source (来源)**: `Custom` (自定义 / OpenAI Compatible)
    *   **API Endpoint (地址)**: `http://127.0.0.1:8000/v1`  <-- **关键！**
    *   **API Key**: 随便填（例如 `123456`），DeepTavern 不验证这个，它用的是你后台配置的 Key。
4.  点击 **Connect (连接)**。如果看到绿色灯亮起，说明连接成功。

### ⚠️ 重要：前端设置注意事项
由于 DeepTavern 已经内置了庞大的系统提示词（System Prompt），为了避免冲突：
1.  **角色卡**：在酒馆里建立一个**空白角色卡**（名字叫 "AI Assistant" 或你喜欢的名字），**不要写任何设定**。
2.  **预设 (Context Template)**：建议使用默认或空白预设，不要在酒馆里开启复杂的“破限”或“世界书”，这会干扰 DeepTavern 的导演逻辑。

---

## 💾 存档管理 (必须手动切换！)

**这是 v0.5 版本与普通酒馆最大的不同点。**

*   酒馆前端的“新建聊天”**不会**重置 DeepTavern 的后台状态（HP、背包、记忆图谱等）。
*   你必须使用 DeepTavern 自带的 **监控台** 来管理存档。

### 如何切换/新建存档：
1.  双击运行项目根目录下的 **`start_editor.bat`** (或者在虚拟环境中运行 `python monitor.py`)。
2.  这会打开 **DeepTavern 控制台**。
3.  点击左侧的 **“存档管理”** 图标。
4.  在这里你可以：
    *   **新建存档**：输入玩家名，开始新的冒险（此时后台状态完全重置）。
    *   **加载存档**：选择旧的 UUID，点击加载。
    *   **删除存档**：连同向量记忆和图谱一起彻底删除。

> **总结**：想开新游戏时，**先在监控台里“新建存档”**，然后在酒馆里“新建聊天”。

---

## 📥 预设清洗工具 (当前功能说明)

在控制中心 (`config_editor.py`) 里，有一个 **“预设清洗工具”** 标签页。

### ✅ 它能做什么？
它可以导入 **SillyTavern 的预设文件 (.json)**。
*   它会利用 LLM 分析预设中的 Prompt（如越狱指令、描写风格要求）。
*   将其转化为 DeepTavern 能理解的**向量规则**。
*   **效果**：当你在游戏中触发特定情境（如战斗、H事件）时，RAG 系统会自动检索这些规则并注入给模型。

### ❌ 暂时不支持的内容 (v0.5)
目前版本暂不支持直接导入 **角色卡** 和 **世界书**。
*   **角色性格**：目前需在 `config_editor.py` 的 Narrator 提示词中手动配置。
*   **世界观**：DeepTavern 目前使用自动化的**知识图谱**代替传统世界书，AI 会在对话中自动学习并建立世界观。

*(正如开头所述，这些兼容性功能将在下一个版本中全面实装！)*

---

## 🤝 贡献与反馈
如果你发现了 Bug，或者有好的建议，欢迎提交 Issue！
